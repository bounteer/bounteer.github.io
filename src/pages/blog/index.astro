---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import HeroSection from "../../components/HeroSection.astro";
import BlogGrid from "../../client_side/hydration/BlogGrid";
import { EXTERNAL } from "@/constant";

// Fetch from your API
const apiUrl = `${EXTERNAL.directus_url}/items/blog_post`; // replace with real endpoint
const baseImageUrl = `${EXTERNAL.directus_url}/assets/`; // for og_image

const res = await fetch(apiUrl);
if (!res.ok) {
  throw new Error("Failed to fetch blog posts");
}

const response = await res.json();
const postsRaw = response.data;

// Map to the format your template expects
const posts = postsRaw.map((post) => ({
  id: post.slug,
  title: post.subject,
  excerpt: post.content.replace(/<[^>]+>/g, "").slice(0, 180) + "...", // strip HTML for excerpt
  date: new Date(post.date_created).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }),
  author: "Admin", // Replace or fetch from relationship
  authorRole: "Content Writer", // Same
  authorAvatar: "https://randomuser.me/api/portraits/lego/1.jpg", // or your own avatar
  category: "Marketing", // Or map from category ID if available
  image: baseImageUrl + post.og_image,
}));

const categories = [...new Set(posts.map((post) => post.category))];
---

<Layout
  title="Blog - Bounteer"
  description="Latest product updates, feature releases, and company news from Bounteer."
>
  <Header />
  <main>
    <HeroSection
      title="Latest Updates & News"
      highlightText="Updates"
      description="Stay up to date with our latest feature releases, and partnership news."
    />

    <!-- BlogGrid -->
    <div class="container-custom py-8">
      <BlogGrid client:load />
    </div>
  </main>
  <Footer />
</Layout>
