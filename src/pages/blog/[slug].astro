---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ShareButton from "../../components/interactive/ShareButton";

// Get all slugs for SSG
export async function getStaticPaths() {
  const res = await fetch(
    "https://directus.ismail.to/items/blog_posts?fields=slug&filter[is_enabled][_eq]=true",
  );
  if (!res.ok) throw new Error("Failed to fetch slugs");
  const data = await res.json();
  return data.data.map((post) => ({
    params: { slug: post.slug },
  }));
}

// Get post content
const { slug } = Astro.params;

const post_url = `https://ismail.to/blog/${slug}`;
const apiUrl = `https://directus.ismail.to/items/blog_posts?filter[slug][_eq]=${slug}&fields=*,user_created.first_name,user_created.last_name,user_created.avatar,user_created.role.name`;
const baseImageUrl = "https://directus.ismail.to/assets/";

const res = await fetch(apiUrl);
if (!res.ok) throw new Error("Failed to fetch blog post");

const post = (await res.json()).data?.[0];
if (!post) throw new Error("Post not found");

// Post data
const title = post.subject;
const author =
  post.user_created?.first_name + " " + post.user_created?.last_name || "Admin";
const role = post.user_created?.role?.name || "Content Writer";
const avatar = post.user_created?.avatar
  ? baseImageUrl + post.user_created.avatar
  : "https://randomuser.me/api/portraits/lego/1.jpg";
const date = new Date(post.date_created).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});
const image_url = post.og_image
  ? baseImageUrl + post.og_image + "?width=1200&height=630&fit=cover"
  : "";
const content = post.content;
const category = post.category;
---

<Layout title={title} name={author} url={post_url} image_url={image_url}>
  <Header>
    <!-- whatsapp/linkedin -->
    <meta name="title" property="og:title" content={title} />
    <meta name="description" property="og:description" content="" />
    <meta name="image" property="og:image" content={image_url} />
    <meta name="url" property="og:url" content={post_url} />
    <meta name="type" property="og:type" content="website" />
    <!-- twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content="" />
    <meta name="twitter:image" content={image_url} />
  </Header>
  <main class="container-custom pt-30 py-16">
    <article class="max-w-3xl mx-auto">
      {
        image_url && (
          <img
            src={image_url}
            alt={title}
            class="w-full object-cover mb-8 rounded-xl"
          />
        )
      }
      <div class="mb-6">
        <p class="text-sm text-primary-600 font-medium">{category}</p>
        <h1
          class="text-5xl scroll-mt-24 font-bold mb-2 text-gray-900 dark:text-white"
        >
          {title}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">{date}</p>
      </div>

      <div
        class="prose dark:prose-invert max-w-none mb-10"
        set:html={content}
      />

      <!-- Share Dropdown -->
      <ShareButton client:load postUrl={post_url} title={title} />

      <!-- Author -->
      <div class="flex items-center mt-10 pt-6 border-t dark:border-gray-700">
        <img
          src={avatar}
          alt={author}
          class="w-12 h-12 rounded-full mr-4 object-cover"
        />
        <div>
          <p class="font-semibold text-gray-900 dark:text-white">{author}</p>
          <p class="text-sm text-gray-600 dark:text-gray-400">{role}</p>
        </div>
      </div>
    </article>
  </main>
  <Footer />
</Layout>
