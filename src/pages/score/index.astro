---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import HeroSection from "../../components/HeroSection.astro";

const DIRECTUS_URL = "https://directus.bounteer.com";
const READ_TOKEN = "5OTK2voWFO_vTptGVMAY2Oxz9XBCDAvn"; // must have create: files + submissions
---

<style is:global>
  [x-cloak] {
    display: none !important;
  }
</style>

<Layout title="Role Fit Score - Bounteer">
  <Header />

  <main>
    <HeroSection
      title="Get Your Role Fit Score"
      highlightText="Role Fit Score"
      description="Instantly analyze how well your CV matches any job description."
      badge="âš¡ AI-Powered Career Matching"
    />

    <section class="py-16 bg-white">
      <div class="container-custom max-w-6xl mx-auto">
        <div
          class="relative rounded-2xl border border-gray-200 shadow-xl p-10 bg-white flex flex-col"
          x-data="(() => {
            const cfg = $el.dataset;
            return {
              // config
              directusUrl: cfg.directusUrl,
              writeToken: cfg.writeToken,

              // state
              isDragging: false,
              isBusy: false,
              fileName: '',
              fileObj: null,
              error: '',
              step: 0, // 0 idle, 1 uploading
              buttonText: 'Analyze Role Fit now',

              // helpers
              autoGrow(el){
                // cap at 60% viewport height
                const max = Math.floor(window.innerHeight * 0.6);
                el.style.height = 'auto';
                el.style.height = Math.min(el.scrollHeight, max) + 'px';
              },

              // file handlers
              handleFile(file){ this.validateFile(file); },
              handleDrop(ev){ const f = ev.dataTransfer.files?.[0]; this.validateFile(f); },
              validateFile(file){
                if(!file){ this.error='No file selected'; return false; }
                const maxSize = 10 * 1024 * 1024;
                const ext = file.name.split('.').pop()?.toLowerCase();
                if(file.size > maxSize){ this.error='File is too large. Max 10MB.'; this.fileName=''; this.fileObj=null; return false; }
                if(ext !== 'pdf' || file.type !== 'application/pdf'){ this.error='Only PDF allowed.'; this.fileName=''; this.fileObj=null; return false; }
                this.error=''; this.fileName=file.name; this.fileObj=file; return true;
              },

              async analyze(){
                try{
                  if(!this.fileObj){ this.error='Please select a PDF'; return; }
                  const jdText = this.$refs.jdInput?.value?.trim();
                  if(!jdText){ this.error='Please paste the JD'; return; }
                  if(!this.directusUrl || !this.writeToken){ this.error='Missing Directus config'; return; }

                  // STEP 1: Upload file
                  this.step = 1; this.isBusy = true; this.buttonText = 'Uploading CVâ€¦';
                  const fd = new FormData();
                  fd.append('file', this.fileObj, this.fileName || 'cv.pdf');

                  const upRes = await fetch(`${this.directusUrl}/files`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${this.writeToken}` },
                    body: fd,
                  });
                  const upJson = await upRes.json();
                  if(!upRes.ok) throw new Error(upJson?.errors?.[0]?.message || 'Upload failed');
                  const fileId = upJson?.data?.id;

                  // STEP 2: Create submission
                  this.buttonText = 'Saving submissionâ€¦';
                  const subRes = await fetch(`${this.directusUrl}/items/role_fit_score_submission`, {
                    method: 'POST',
                    headers: {
                      Authorization: `Bearer ${this.writeToken}`,
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ jd_text: jdText, cv_file: fileId, status: 'uploaded' }),
                  });
                  const subJson = await subRes.json();
                  if(!subRes.ok) throw new Error(subJson?.errors?.[0]?.message || 'Submission failed');
                  const submissionId = subJson?.data?.id;

                  // Redirect (static-friendly)
                  window.location.href = `/score/report?id=${encodeURIComponent(submissionId)}`;
                }catch(e){
                  this.error = e?.message || 'Unexpected error';
                  this.isBusy = false; this.step = 0; this.buttonText = 'Analyze Role Fit now';
                }
              }
            }
          })()"
          data-directus-url={DIRECTUS_URL}
          data-write-token={READ_TOKEN}
        >
          <!-- FULL-CARD OVERLAY -->
          <div
            x-show="step===1"
            class="absolute inset-0 z-50 flex items-center justify-center bg-white/80 backdrop-blur-sm"
            aria-live="polite"
            role="status"
            x-cloak
          >
            <div class="flex flex-col items-center gap-4">
              <svg
                class="h-12 w-12 animate-spin"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <circle
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                  fill="none"
                  opacity="0.25"></circle>
                <path
                  d="M4 12a8 8 0 018-8"
                  stroke="currentColor"
                  stroke-width="4"
                  fill="none"></path>
              </svg>
              <p class="text-base font-medium text-gray-900">Uploading CVâ€¦</p>
              <p class="text-sm text-gray-600">
                Please wait while we upload your file to Directus.
              </p>
            </div>
          </div>

          <h3 class="text-2xl font-semibold text-gray-900 mb-8">
            Upload JD and CV
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-stretch">
            <!-- JD (auto-grow textarea only) -->
            <div class="flex flex-col">
              <label
                for="job-description"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                Job Description (Text or URL)
              </label>

              <textarea
                id="job-description"
                x-ref="jdInput"
                :disabled="isBusy"
                placeholder="Paste the JD or a JD URLâ€¦"
                @input="autoGrow($event.target)"
                x-init="autoGrow($el)"
                class="block w-full rounded-lg border-2 border-dashed border-gray-300
                       p-8 text-sm text-gray-700 placeholder:text-gray-400
                       focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500
                       min-h-[260px] md:min-h-[300px] resize-none overflow-auto
                       transition disabled:opacity-60 disabled:pointer-events-none"
              ></textarea>
            </div>

            <!-- CV dropzone -->
            <div
              @dragover.prevent="isDragging = true"
              @dragleave.prevent="isDragging = false"
              @drop.prevent="isDragging = false; handleDrop($event)"
              :class="isBusy ? 'opacity-60 pointer-events-none' : ''"
              class="flex flex-col"
            >
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Upload CV (PDF only)
              </label>

              <div
                class="border-2 border-dashed rounded-lg p-8 text-center transition
                       min-h-[260px] md:min-h-[300px] h-full flex flex-col items-center justify-center"
                :class="isDragging ? 'border-primary-500 bg-primary-50' : 'border-gray-300'"
              >
                <div class="flex flex-col items-center justify-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-12 w-12 text-gray-400 mb-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12V4m0 8l-3-3m3 3l3-3"
                    ></path>
                  </svg>
                  <p class="text-sm text-gray-600">
                    Drag & Drop your CV here <br />
                    or
                    <label
                      class="underline text-primary-600 cursor-pointer hover:text-primary-700"
                    >
                      <input
                        type="file"
                        accept="application/pdf"
                        class="hidden"
                        @change="handleFile($event.target.files?.[0])"
                      />
                      choose a file
                    </label>
                    <br /> Supports PDF up to 10MB
                  </p>
                </div>

                <!-- reserved rows to prevent jump -->
                <div class="mt-4 w-full max-w-xs min-w-0 mx-auto">
                  <div class="h-6 flex items-center justify-center">
                    <p
                      x-show="fileName"
                      x-cloak
                      class="text-sm text-blue-600 font-medium truncate max-w-full"
                      x-text="`ðŸ“„ ${fileName}`"
                    >
                    </p>
                  </div>
                  <div class="h-5 flex items-center justify-center">
                    <p
                      x-show="error"
                      x-cloak
                      class="text-sm text-red-600"
                      x-text="error"
                    >
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Primary button -->
          <div class="mt-10 relative h-12">
            <button
              x-cloak
              x-show="!isBusy && step === 0"
              x-transition.opacity.scale
              type="button"
              class="btn-primary w-full h-12 flex items-center justify-center gap-2"
              @click.prevent="analyze"
            >
              <span x-text="buttonText"></span>
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>
